# S3 Bucket

## Enumeration

### Discovering Bucket Names

    http://BUCKETNAME.s3.amazonaws.com/FILENAME.ext
    http://s3.amazonaws.com/BUCKETNAME/FILENAME.ext


### List bucket

#### With no sign request

    aws s3 ls --endpoint-url=http://domain.com --no-sign-request
    aws s3 ls --endpoint-url=http://BUCKETNAME.s3.amazonaws.com/ --no-sign-request
    aws s3 ls s3://BUCKETNAME/ --no-sign-request

The option `--no-sign-request` allows you to request data from S3 without being an AWS Customer. 

#### With sign request

##### AWS IAM

IAM Access Keys

    Access Key ID:          Start with the letters AKIA and are 20 characters long
    Secret Access Key:      40 characters long

Short-term credentials

    Access Key ID:          begins with the letters ASIA and includes an additional string called the Session Token. 


Config key 

    aws Config
    aws configure --profile PROFILENAME

Config files

    ~/.aws/config
    ~/.aws/credentials

##### Request

    aws s3 ls --endpoint-url=http://domain.com

> S3api

    aws s3api list-buckets --endpoint-url=http://domain.com | jq
    aws s3api get-bucket-acl --endpoint-url=http://domain.com --bucket BucketName  | jq
    aws s3api list-objects --endpoint-url=http://domain.com --bucket BucketName | jq 

> Dynamodb

    aws dynamodb list-global-tables --endpoint-url http://domain.com | jq
    aws dynamodb list-tables --endpoint-url http://domain.com | jq
    aws dynamodb scan --table-name TableName --endpoint-url http://domain.com  | jq

### Reconnaissance techniques

Finding the Account ID belonging to an access key:

    aws sts get-access-key-info --access-key-id AKIAEXAMPLE 

Determining the Username the access key you're using belongs to

    aws sts get-caller-identity --profile PROFILENAME

Listing all the EC2 instances running in an account

    aws ec2 describe-instances --output text --profile PROFILENAME

Listing all the EC2 instances running in an account in a different region

    aws ec2 describe-instances --output text --region us-east-1 --profile PROFILENAME

### Secrets Manager

Get commands 

    aws secretsmanager help

List secrets

    aws secretsmanager list-secrets

Get secrets

    aws secretsmanager get-secret-value --secret-id

## Exploit 

> Create bucket

    aws s3 create-bucket --bucket BucketName

> Move File

    aws s3 mv YourFile s3://BucketName/TargetFile --no-sign-request

> Copy Files

    aws s3 cp YourFile s3://BucketName/TargetFile --no-sign-request

> Delete Files

    aws s3 rm s3://BucketName/TargetFile --no-sign-request

## Aws - Regions and Zones

    Code	        Name	                Opt-in Status
    us-east-2	    US East (Ohio)	        Not required
    us-east-1	    US East (N. Virginia)	Not required
    us-west-1	    US West (N. California)	Not required
    us-west-2	    US West (Oregon)	    Not required
    af-south-1	    Africa (Cape Town)	    Required
    ap-east-1	    Asia Pacific (Hong Kong)	Required
    ap-south-1	    Asia Pacific (Mumbai)	Not required
    ap-northeast-3	Asia Pacific (Osaka)	Not required
    ap-northeast-2	Asia Pacific (Seoul)	Not required
    ap-southeast-1	Asia Pacific (Singapore)	Not required
    ap-southeast-2	Asia Pacific (Sydney)	Not required
    ap-northeast-1	Asia Pacific (Tokyo)	Not required
    ca-central-1	Canada (Central)	    Not required
    eu-central-1	Europe (Frankfurt)	    Not required
    eu-west-1	    Europe (Ireland)	    Not required
    eu-west-2	    Europe (London)	        Not required
    eu-south-1	    Europe (Milan)	        Required
    eu-west-3	    Europe (Paris)	        Not required
    eu-north-1	    Europe (Stockholm)	    Not required
    me-south-1	    Middle East (Bahrain)	Required
    sa-east-1	    South America (SÃ£o Paulo)	Not required

## Source 

- https://medium.com/@janijay007/s3-bucket-misconfiguration-from-basics-to-pawn-6893776d1007
- https://medium.com/techiepedia/s3-bucket-misconfiguration-50883f347869
- https://docs.aws.amazon.com/cli/latest/reference/dynamodb/list-tables.html
- https://docs.aws.amazon.com/cli/latest/reference/s3api/create-bucket.html
- https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-regions-availability-zones.html
- https://tryhackme.com/room/adventofcyber3